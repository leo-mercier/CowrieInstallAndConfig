import re
import os
import json


cowrieSessions = {}


def analyzeLogsCowrie(sid):
        if l['eventid'] == 'cowrie.session.connect' and l['session'] not in cowrieSessions:
                cowrieSessions[sid] = {}
                cowrieSessions[sid]['timestamp_start'] = l['timestamp']
                cowrieSessions[sid]['source_ip'] = l['src_ip']
                cowrieSessions[sid]['source_port'] = l['src_port']
                cowrieSessions[sid]['target_ip'] = l['dst_ip']
                cowrieSessions[sid]['target_port'] = l['dst_port']
                cowrieSessions[sid]['session_id'] = l['session']
                cowrieSessions[sid]['protocol'] = l['protocol']

        if l['eventid'] == 'cowrie.login.success' and l['session'] in cowrieSessions:
                cowrieSessions[sid]['login'] = "Success"
                cowrieSessions[sid]['username'] = l['username']
                cowrieSessions[sid]['password'] = l['password']
                cowrieSessions[sid]['timestamp_login'] = l['timestamp']

        if l['eventid'] == 'cowrie.login.failed' and l['session'] in cowrieSessions:
                cowrieSessions[sid]['login'] = "Fail"
                cowrieSessions[sid]['username'] = l['username']
                cowrieSessions[sid]['password'] = l['password']
                cowrieSessions[sid]['timestamp_login'] = l['timestamp']

        if l['eventid'] == 'cowrie.session.closed' and l['session'] in cowrieSessions:
                cowrieSessions[sid]['timestamp_close'] = l['timestamp']

        if l['eventid'] == 'cowrieSession.command.input' and l['session'] in cowrieSessions:
                cowrieSessions[sid]['input'] = l['input']

        if l['eventid'] == 'cowrie.client.version' and l['session'] in cowrieSessions:
                if "b'" in l["version"]:
                        cowrieSessions[sid]['version'] = re.search(r"b'(.*)'", l["version"], re.M).group(1)
                else:
                        cowrieSessions[sid]['version'] = l["version"]


if __name__ == '__main__':
        f = open('cowrie.json', 'r')

        data = f.readlines()
        cnt = 0
        for l in data:
                l = json.loads(l)
                sid = l['session']
                analyzeLogsCowrie(sid)
                cnt = cnt+1
        print(cnt)

        f.close()

        for session in cowrieSessions:
                if str(cowrieSessions[session]['target_port']) == "23" or str(cowrieSessions[session]['target_port']) == "2323":
                        cowrieSessions[session]['Description'] = "Telnet Honeypot Cowrie"
                else:
                        cowrieSessions[session]['Description'] = "SSH Honeypot Cowrie"
        print(len(cowrieSessions))
        with open('result.json', 'w') as res:
                json_formated = json.dumps(cowrieSessions, indent=4)
                res.writelines(json_formated)
